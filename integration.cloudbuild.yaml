# Copyright 2024 Google LLC
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

steps:
  # Step 1: Deploy BCEL App (Create temporary service)
  - id: "Deploy BCEL App"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "${_SERVICE}"             # ‡∏ä‡∏∑‡πà‡∏≠ Service ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∫ï‡∫≤‡∫° Build ID
      - "--source"
      - "."
      - "--region"
      - "${_REGION}"
      - "--allow-unauthenticated" # ‡ªÄ‡∫õ‡∫µ‡∫î‡ªÉ‡∫´‡ªâ‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤‡ªÄ‡∫ñ‡∫¥‡∫á‡ªÑ‡∫î‡ªâ (‡ªÄ‡∫û‡∫∑‡ªà‡∫≠‡∫ó‡∫ª‡∫î‡∫™‡∫≠‡∫ö)
      - "--set-env-vars"
      - "TOOLBOX_URL=${_TOOLBOX_URL}"

  # Step 2: Test the running App (Automated Test)
  - id: "Test BCEL App"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: /bin/bash
    args:
      - -c
      - |
        # 1. ‡∫î‡∫∂‡∫á URL ‡∫Ç‡∫≠‡∫á Service ‡∫ó‡∫µ‡ªà‡∫´‡∫≤‡∫Å‡ªç‡ªà‡∫™‡ªâ‡∫≤‡∫á
        export URL=$(gcloud run services describe ${_SERVICE} --region ${_REGION} --format 'value(status.url)')
        export ID_TOKEN=$(gcloud auth print-identity-token)

        echo "Starting tests on: $$URL"

        # Test A: Ping ‡∫´‡∫ô‡ªâ‡∫≤‡∫ó‡∫≥‡∫≠‡∫¥‡∫î (/)
        # ‡∫ï‡ªâ‡∫≠‡∫á‡ªÑ‡∫î‡ªâ HTTP 200 OK
        curl -si --fail --show-error -H "Authorization: Bearer $$ID_TOKEN" $$URL > /dev/null
        if [ $? -eq 0 ]; then
          echo "‚úÖ Root Endpoint Test: PASSED"
        else
          echo "‚ùå Root Endpoint Test: FAILED"
          exit 1
        fi

        # Test B: Ping ‡∫´‡∫ô‡ªâ‡∫≤‡ªÅ‡∫ä‡∫ó (/chat)
        # ‡∫ï‡ªâ‡∫≠‡∫á‡ªÑ‡∫î‡ªâ HTTP 400 (‡ªÄ‡∫û‡∫≤‡∫∞‡ªÄ‡∫Æ‡∫ª‡∫≤‡∫ç‡∫¥‡∫á‡ªÑ‡∫õ‡ªÇ‡∫î‡∫ç‡∫ö‡ªç‡ªà‡∫°‡∫µ Session Cookie)
        # ‡∫ô‡∫µ‡ªâ‡ªÄ‡∫õ‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡ªÄ‡∫ä‡∫±‡∫Å‡∫ß‡ªà‡∫≤ Logic ‡ªÉ‡∫ô app.py ‡ªÄ‡∫Æ‡∫±‡∫î‡∫ß‡∫Ω‡∫Å‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á
        msg=$(curl -si --show-error \
          -X POST \
          -H "Authorization: Bearer $$ID_TOKEN" \
          -H 'Content-Type: application/json' \
          -d '{"prompt":"Sabaidee"}' \
          $$URL/chat)

        if grep -q "400" <<< "$msg"; then
          echo "‚úÖ Chat Logic Test: PASSED (Correctly rejected session-less request)"
        else
          echo "‚ùå Chat Logic Test: FAILED"
          echo "$msg"
          exit 1
        fi

  # Step 3: Cleanup (Delete everything)
  - id: "Delete BCEL App"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    script: |
        #!/usr/bin/env bash
        echo "üßπ Cleaning up resources..."
        
        # ‡∫•‡∫ª‡∫ö Image ‡ªÉ‡∫ô Container Registry
        gcloud artifacts docker images delete $_GCR_HOSTNAME/$PROJECT_ID/cloud-run-source-deploy/$_SERVICE --quiet || true
        
        # ‡∫•‡∫ª‡∫ö Cloud Run Service
        gcloud run services delete ${_SERVICE} --region ${_REGION} --quiet

# ‡∫Å‡∫≤‡∫ô‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤‡∫ï‡∫ª‡∫ß‡ªÅ‡∫õ (Substitutions)
substitutions:
  _GCR_HOSTNAME: us-central1-docker.pkg.dev
  _SERVICE: bcel-test-${BUILD_ID}   # ‡∫ï‡∫±‡ªâ‡∫á‡∫ä‡∫∑‡ªà Service ‡ªÉ‡∫´‡ªâ‡∫ö‡ªç‡ªà‡∫ä‡ªâ‡∫≥‡∫Å‡∫±‡∫ô‡ªÉ‡∫ô‡ªÅ‡∫ï‡ªà‡∫•‡∫∞‡∫Ñ‡∫±‡ªâ‡∫á
  _REGION: us-central1
  # ‚ö†Ô∏è ‡∫™‡∫≥‡∫Ñ‡∫±‡∫ô: ‡ªÉ‡∫™‡ªà URL ‡∫Ç‡∫≠‡∫á Toolbox ‡∫ó‡∫µ‡ªà‡∫ó‡ªà‡∫≤‡∫ô Deploy ‡ªÑ‡∫ß‡ªâ‡∫ñ‡∫≤‡∫ß‡∫≠‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß‡∫ó‡∫µ‡ªà‡∫ô‡∫µ‡ªâ
  _TOOLBOX_URL: https://bcel-toolbox-xyz.a.run.app 

options:
  logging: CLOUD_LOGGING_ONLY